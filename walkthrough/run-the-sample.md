# Running the Who Knows Whom sample

In this walkthrough, we'll take you step-by-step to setup and run the Who Knows Who sample application.

## Prerequisites

- Visual Studio 2017
- Office 365 tenant with Azure subscription - The tenant should have users with data in their mailboxes.
- [Azure AD Powershell](https://docs.microsoft.com/en-us/powershell/azure/active-directory/install-adv2?view=azureadps-2.0)
- [Azure Powershell](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps)

## Package the web application

Open the **./src/WhoKnowsWho.sln** solution in Visual Studio 2017. This solution contains the web application which will consume and process the data in the Azure Data Lake Store created by Project Euclid.

### Create the package

1. Right-click the **WhoKnowsWho** solution in **Solution Explorer** and choose **Restore NuGet Packages**.
1. Select the **WhoKnowsWho** project in **Solution Explorer**. Select the **Build** menu, then **Publish WhoKnowsWho**.
1. TODO: Either check-in pubxml or give steps to create one.
1. Select the **WebPackage** publishing profile and select **Publish**.

This should generate a **WhoKnowsWho.zip** file in the directory you specified as the output directory in the publishing profile.

### Upload the package to blob storage

In this step we'll create a storage account and upload the **WhoKnowsWho.zip** file as a blob. This will allow us to include the web application as part of the Azure managed application we'll create later.

1. Follow the steps in [Create a storage account](https://docs.microsoft.com/en-us/azure/storage/common/storage-quickstart-create-account?tabs=portal) to create a storage account.
1. Follow the steps in the [Create a container](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal#create-a-container) section and the [Upload a block blob](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal#upload-a-block-blob) section of [Quickstart: Upload, download, and list blobs using the Azure portal](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-portal) to upload **WhoKnowsWho.zip**.

    > **Note:** Be sure to select **Blob (anonymous read access for blobs only)** in the **Public access level** dropdown when creating the container.
1. Select the **WhoKnowsWho.zip** blob and copy the **URL** value.

## Create a managed application

The first step is to create an [Azure managed application](https://docs.microsoft.com/en-us/azure/managed-applications/). Let's start by creating a [resource template](https://docs.microsoft.com/en-us/azure/managed-applications/publish-service-catalog-app#create-the-resource-template) that will provision all of the needed resources.

1. Open the **./ManagedApp/mainTemplate.json** file.
1. Locate the `webAppRemote` value. Change this value to the URL of the **WhoKnowsWho.zip** blob you created above.
1. Save the file.
1. Create a new ZIP file named **app.zip** that contains **./ManagedApp/mainTemplate.json** and **./ManagedApp/createUiDefinition.json**.
1. Upload **app.zip** to the blob container you created above and copy the **URL** value.

### Deploy the managed application definition

Now we can deploy the application definition into your test organization. This will make the application available in your organization's service catalog.

1. Open Powershell in the **./ManagedApp/Scripts** directory.
1. Run the **DeployManagedApp.ps1** script with the following parameters:

    ```Shell
    .\DeployManagedApp.ps1 -ResourceGroupLocation "East US" -ResourceGroupName wkwmanagedapp -PackageFileUri "URL to app.zip in blob storage"
    ```

You will be prompted to login twice. Use an admin account for your test tenant in both logins.

## Install the managed application

The next step is to insall the managed application. This will provision all of the resources specified in the resource template, including the Euclid data pipeline and the sample web application.

1. Run the **GetAppInstallationParameters.ps1** script with no parameters. You will be prompted to login, use an admin account for your test tenant. This will create an application service principal for the sample and output information. Save these values to use during the installation of the managed app.
1. Logon to the Azure portal.
1. In the search bar, enter `Managed applications` and select **Managed applications** under **Services**.

    ![A screenshot of the search bar with 'Managed applications'](/doc-images/managed-apps-in-portal.PNG)
1. Select **Add**, then select **Euclid Who Knows Whom Sample App**. Select **Create**.
1. On the **Basics** screen, select your subscription and either create a new resource group or use an existing one, then select **OK**.
1. On the **Web App Settings** screen, enter the **Website name** value generated by the **GetAppInstallationParameters.ps1** script, then select **OK**.
1. On the **Data Factory Settings** screen enter the corresponding values from the output of the **GetAppInstallationParameters.ps1** script, then select **OK**.
1. On the **Summary** screen, wait for the validation to complete and select **OK**.

At this point the deployment starts and may take a few minutes. You can monitor the progress of the deployment in the **Notifications** pane in the Azure portal. Wait for the deployment to complete before moving on to the next section.

## Kickstart the data pipeline

During the installation of the managed application, the data pipeline was provisioned and scheduled to run once a day. However, before it will run, you must kickstart it by manually triggering the pipeline.

1. In the Azure Portal, select **All Resources** in the left-hand menu.
1. Select the **Data factory (V2)** type resource from the list with a name that starts with `O365ToAzureDLSDataFactory`.
1. In the Data Factory window, select **Author & Monitor**. This will open a new window or tab in your browser to the Azure Data Factory portal.
1. In the Azure Data Factory portal, select the **Author** icon in the left bar.
1. Under **Pipelines**, select **O365ToADLSPipeline**.
1. Select **Trigger**, then **Trigger Now**.
1. In the **Pipeline Run** pane, select **Finish**.

This will start a pipeline run. Select the **Monitor** icon in the left bar to see the run and monitor its progress. Wait for the pipeline run to complete before moving on to the next section.

### Verify the pipeline

Once the pipeline run has completed, let's verify that data has been transferred into the Azure Data Lake Store.

1. In the Azure Portal, select **All Resources** in the left-hand menu.
1. Select the **Data Lake Store** type resource from the list with a name that starts with `destaccount`.
1. In the Data Lake Store window, select **Data Explorer** from the left-hand menu.
1. In the Data Explorer window, select the **targetFolder** folder.
1. There should be one or more documents in the **targetFolder** folder. Select one to open it.
1. The file should contain JSON-formatted information about email messages from users in your tenant.

Now that we've verified that the data pipeline is working, we can try the sample web app.

## Using the sample web app

1. Open your browser and browse to `https://<websitename>.azurewebsites.net`, where `<websitename>` is the value of **Website name** you provided during the installation of the managed application.
1. If prompted to login, use your tenant admin account.
1. Accept the prompt advising that the app would like to sign you in and read your profile.
1. At the bottom of the page, enter one of your user's email address and click the search button.

### (Optional) - Set up the sample app to run locally

This next section will walk through the process of getting the sample running locally to make it easier to debug and experiment.

#### Update the application registration

When we deployed the application, we created an app registration in Azure AD for the sample web app. The app registration is configured to allow the deployed URL `https://<websitename>.azurewebsites.net`, but we want to be able to run this on localhost. To do this we need to add the localhost URL as an allowed reply URL.

1. In the Azure Portal, select **Azure Active Directory** in the left-hand menu.
1. Select **App registrations**.
1. In the app registrations window, change the drop-down from **My apps** to **All apps**.
1. Find the entry that has a display name that matches the **Website name** of the deployed sample application and select it.
1. Select **Settings**.
1. Select **Reply URLs**.
1. In the reply URLs window, enter `http://localhost:2611/` in the empty input field and select **Save**.

![A screenshot of the Reply URLs window with the localhost URL added](/doc-images/app-reg-localhost-added.PNG)

#### Configure the sample application

Next we need to fill in some values in the **Web.config** file for the sample app. Open the **./src/WebApp/Web.config** file in Visual Studio, and locate the `appSettings` element. Underneath this element are a number of `add` elements that have empty `value` attributes. Fill in the `value` attributes of these elements according to the following table.

| Key | Value |
|-----|-------|
| `ida:ClientId` | Set to the **Destination ADLS service principal Id** value output from running **GetAppInstallationParameter.ps1** during installation. |
| `ida:AADInstance` | `https://login.microsoftonline.com/` |
| `ida:TenantId` | Set to the **The O365 tenant for which data needs to be extracted** value output from running **GetAppInstallationParameter.ps1** during installation. |
| `ida:PostLogoutRedirectUri` | `http://localhost:2611` |
| `adls:ClientId` | Set to the **Destination ADLS service principal Id** value output from running **GetAppInstallationParameter.ps1** during installation. |
| `adls:ClientSecret` | Set to the **Destination ADLS service principal key** value output from running **GetAppInstallationParameter.ps1** during installation. |
| `adls:TenantId` | Set to the **The O365 tenant for which data needs to be extracted** value output from running **GetAppInstallationParameter.ps1** during installation. |
| `adls:AccountName` | Set to the name of the **Data Lake Store** resource listed in the Azure Portal. It should begin with `destaccount`. |
| `adls:Path` | `targetFolder` |